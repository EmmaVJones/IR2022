---
title: "Data Outside 2020 IR Window"
author: "Emma Jones"
date: "6/17/2020"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(sf)
library(readxl)
library(DT)

```

## Background

This report works through a method to identify which stations do not have valid data inside the 2020 IR window. Stations listed as impaired are deemed valid even if they do not have data in a given window (carryover stations). Citizen Monitoring/Non agency stations will be flagged but not dropped from this analysis. Not all citmon/non agency data resides in 'Conventionals' (yet), so we cannot be sure what stations definitely need to be dropped.

### Data Input

We will start with Cleo's final stations file for 2020IR.

```{r 2020 final stations, warning=F, message=F}
final2020 <- st_read('GIS/2020_wqms.shp') %>%
  st_transform(4326)
```

And Roger's 'Conventionals' data pull for the 2020 IR window (2013-2018). We will change the date/time field to an appropriate format for filtering and remove sites that are missing either a latitude or longitude value. Those sites are summarized below.

```{r conventionals, warning=F, message=F}
conventionals <- read_csv('data/CEDSWQM_2020_IR_DATA-CONVENTIONALS_20190305.csv') %>%
  mutate(FDT_DATE_TIME2 = as.POSIXct(FDT_DATE_TIME, format="%m/%d/%Y %H:%M")) # get date in appropriate format for filtering

datatable(  filter(conventionals, is.na(Latitude)|is.na(Longitude)) %>% # remove sites without coordinates
  distinct(FDT_STA_ID, .keep_all = T) %>% # just show one row per issue
  dplyr::select(FDT_STA_ID:STA_REC_CODE, Latitude, Longitude), rownames = F, 
   extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel')
  )
)


conventionals <- filter(conventionals, !is.na(Latitude)|!is.na(Longitude)) # remove sites without coordinates
```

Now let's make a dataset of distinct sites sampled in the window by dropping all data in window.

```{r conventionals distinct, warning=F, message=F}
conventionals_D <- distinct(conventionals, FDT_STA_ID, .keep_all = T) %>%
  select(FDT_STA_ID:FDT_SPG_CODE, Latitude:STA_CBP_NAME, -FDT_DATE_TIME) # drop data to avoid any confusion 
rm(conventionals) # remove full conventionals dataset to save memory
```

### Analysis

The first step is to join on Station ID, but first we need to make a special joining field since some StationID's use lower case letters. 

```{r conventionals join, warning=F, message=F}
final2020withData <- mutate(final2020, FDT_STA_ID = toupper(STATION_ID)) %>% # get rid of lowercase issues
  left_join(conventionals_D, by = 'FDT_STA_ID') %>% # join on the new field
  filter(!is.na(STA_DESC)) # drop stations that didn't appear in conventionals
  
```

Now remove the stations that joined with conventionals from our "to do" list.

```{r drop joined conventionals stations, warning=F, message=F}
final2020toDo <- mutate(final2020,  FDT_STA_ID = toupper(STATION_ID)) %>% # get rid of lowercase issues
  filter(! FDT_STA_ID %in% final2020withData$FDT_STA_ID)

```

#### Monitored vs Assessed

For the stations that joined (i.e. were sampled 2013-2108), we need to add some field to help us out. First we will automatically give these stations a TRUE for the new field MONITOR_STATUS because they were monitored in the 2020 assessment cycle. Next we will assign a field called ASSESSMENT_STATUS to denote whether something is assessed or not. A station is assessed if any of the _STAT fields contain a 'S' (or 'FS') or 'IM' designation.


```{r monitored vs assessed, warning=F, message=F}
final2020withDataAssess <- final2020withData %>%
  st_drop_geometry() %>%
  dplyr::select(FDT_STA_ID, contains("_STAT") )  %>%
  pivot_longer(-FDT_STA_ID, names_to = 'Parameter', values_to = 'Result') %>%
  group_by(FDT_STA_ID) %>%
  filter(Result %in% c('S','IM', 'FS')) %>%
  ungroup() %>%
  distinct(FDT_STA_ID) %>%
  mutate(ASSESSMENT_STATUS = TRUE) %>%
  full_join(final2020withData, by= 'FDT_STA_ID') %>%
  mutate(MONITOR_STATUS = TRUE) %>%
  dplyr::select(names(final2020withData), MONITOR_STATUS, ASSESSMENT_STATUS )

datatable(final2020withDataAssess, rownames = F,
           extensions = 'Buttons', options = list(
    dom = 'Bfrtip', scrollX = T, scrollY = '300px',
    buttons = c('copy', 'csv', 'excel')
  )
)
```


Here are all the sites that were sampled in 2020 IR window but lacked a S, FS, or IM designations for any parameter. These are generated by filtering table above with is.na(ASSESSMENT_STATUS). Might want to dig into these.

```{r assessed?, warning=F, message=F}
datatable(filter(final2020withDataAssess, is.na(ASSESSMENT_STATUS)), rownames = F,
           extensions = 'Buttons', options = list(
    dom = 'Bfrtip', scrollX = T, scrollY = '300px',
    buttons = c('copy', 'csv', 'excel')
  )
)
```


#### Juicy Stuff

Now to figuring out what is going on with the final2020toDo (stations that didn't join to data from 2013-2018).

First let's drop anything not sampled by DEQ bc we just don't have good ways of organizing that data for now. Those sites are displayed below.

```{r drop nonA, warning=F, message=F}
final2020nonA <- filter(final2020toDo, DEQ_STA == "N")

# and drop from to do
final2020toDo <- filter(final2020toDo, ! FDT_STA_ID %in% final2020nonA$FDT_STA_ID)

datatable(final2020nonA, rownames = F,
           extensions = 'Buttons', options = list(
    dom = 'Bfrtip', scrollX = T, scrollY = '300px',
    buttons = c('copy', 'csv', 'excel')  ))
```

Now let's run that same 'ASSESSMENT_STATUS' analysis on these remaining `r nrow(final2020toDo)` sites to see where we may have some lingering problems.

```{r assessment status not in window, warning=F, message=F}
final2020toDoAssess <- final2020toDo %>%
  st_drop_geometry() %>%
  dplyr::select(FDT_STA_ID, contains("_STAT") )  %>%
  pivot_longer(-FDT_STA_ID, names_to = 'Parameter', values_to = 'Result') %>%
  group_by(FDT_STA_ID) %>%
  filter(Result %in% c('S','IM', 'FS')) %>%
  ungroup() %>%
  distinct(FDT_STA_ID) %>%
  mutate(ASSESSMENT_STATUS = TRUE) %>%
  full_join(final2020toDo, by= 'FDT_STA_ID') %>%
  mutate(MONITOR_STATUS = TRUE) %>%
  dplyr::select(names(final2020toDo), MONITOR_STATUS, ASSESSMENT_STATUS )

datatable(final2020toDoAssess, rownames = F,
           extensions = 'Buttons', options = list(
    dom = 'Bfrtip', scrollX = T, scrollY = '300px',
    buttons = c('copy', 'csv', 'excel')
  )
)
```

Here are all the sites that were not sampled in 2020 IR window and lacked a S, FS, or IM designations for any parameter. These are generated by filtering table above with is.na(ASSESSMENT_STATUS). Definitely want to dig into these.

```{r assessed not in window?, warning=F, message=F}
datatable(filter(final2020withDataAssess, is.na(ASSESSMENT_STATUS)), rownames = F,
           extensions = 'Buttons', options = list(
    dom = 'Bfrtip', scrollX = T, scrollY = '300px',
    buttons = c('copy', 'csv', 'excel')
  )
)
```

